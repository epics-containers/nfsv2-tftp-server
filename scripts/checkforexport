################################
#This will likely be deprecated
#but this script checks if any unapplied instructions for IOC provisioning
#exist, then applies them, this includes adding paths to the IOC 
#to /etc/exports and creating a symbolic link to the bootfile of the IOC
#This script should run at startup, and checks for updates every 15 seconds
################################   

rm -f /myioc_env_vars
touch /myioc_env_vars
while true; do sleep 15;
    #suppresses printing to stdout
    diff /iocs/iocs_env_vars /myioc_env_vars > /tmp/env_var_diff_dump || \
    #check if any changes made, then apply them
    while read -r line;
        do 
        [ ! -z "$line" ] && 
        #for each line, checks if path is in exports, and if not, adds it.
        iocPath=/iocs/`echo $line | awk '{print $1}'`/`echo $line | awk '{print $4}'`;
        grep `echo "$iocPath"` /etc/exports || /scripts/addexport `echo "$iocPath"` `echo $line | awk '{print $5}'`;
        bootfilePath=/iocs/`echo $line | awk '{print $1}'`/`echo $line | awk '{print $4}'`/bin/RTEMS-beatnik/`echo $line | awk '{print $2}'`.boot;
        tftpbootPath=/tftpboot/`echo $line | awk '{print $1}'`_`echo $line | awk '{print $2}'`.boot;
        rm -rf $tftpbootPath; ln -s $bootfilePath $tftpbootPath;
        done < /iocs/ioc_env_vars
    cp /iocs/ioc_env_vars /myioc_env_vars
    done

    